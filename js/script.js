const translations = {
	en: {
		flag: "ğŸ‡ºğŸ‡¸",
		header_title: "Scratch Lottery Simulation",
		header_desc: "Test your luck with a scratch-off lottery!",
		scratch_title: "Scratch the Lottery",
		scratch_button: "Scratch",
		next_lottery_button: "Next Lottery",
		reset_button: "Reset",
		probability_label: "Set Winning Probability (%)",
		apply_probability_button: "Apply Probability",
		jackpot_modal_title: "Winning Result",
		cost_summary_title: "Cost Summary",
		currency_symbol: "$",
		scratch_here: "Please scratch the lottery!",
		scratch_label: "Scratch!",
		winning_message: "Congratulations!",
		no_luck: "No luck!",
		lottery_logs: "Lottery Logs",
	},
	es: {
		flag: "ğŸ‡ªğŸ‡¸",
		header_title: "SimulaciÃ³n de LoterÃ­a Rascada",
		header_desc: "Â¡Prueba tu suerte con un rasca y gana!",
		scratch_title: "Rasca la LoterÃ­a",
		scratch_button: "Rascar",
		next_lottery_button: "Siguiente LoterÃ­a",
		reset_button: "Restablecer",
		probability_label: "Establecer Probabilidad de Ganar (%)",
		apply_probability_button: "Aplicar Probabilidad",
		jackpot_modal_title: "Resultado de Ganancia",
		cost_summary_title: "Resumen de Costos",
		currency_symbol: "â‚¬",
		scratch_here: "Â¡Por favor raspa la loterÃ­a!",
		scratch_label: "Â¡Raspa!",
		winning_message: "Â¡Felicidades!",
		no_luck: "Â¡Sin suerte!",
		lottery_logs: "Registros de LoterÃ­a",
	},
	zh: {
		flag: "ğŸ‡¨ğŸ‡³",
		header_title: "åˆ®åˆ®ä¹æ¨¡æ‹Ÿ",
		header_desc: "æµ‹è¯•ä½ çš„è¿æ°”ï¼Œåˆ®åˆ®ä¹æ¥å•¦ï¼",
		scratch_title: "åˆ®åˆ®ä¹",
		scratch_button: "åˆ®åˆ®",
		next_lottery_button: "ä¸‹ä¸€ä¸ªå½©ç¥¨",
		reset_button: "é‡ç½®",
		probability_label: "è®¾ç½®ä¸­å¥–æ¦‚ç‡ (%)",
		apply_probability_button: "åº”ç”¨æ¦‚ç‡",
		jackpot_modal_title: "ä¸­å¥–ç»“æœ",
		cost_summary_title: "æˆæœ¬æ€»ç»“",
		currency_symbol: "Â¥",
		scratch_here: "è¯·åˆ®åˆ®å½©ç¥¨ï¼",
		scratch_label: "åˆ®ï¼",
		winning_message: "æ­å–œä½ !",
		no_luck: "æ²¡æœ‰è¿æ°”ï¼",
		lottery_logs: "å½©ç¥¨è®°å½•",
	},
	de: {
		flag: "ğŸ‡©ğŸ‡ª",
		header_title: "Rubbellose Simulation",
		header_desc: "Teste dein GlÃ¼ck mit einem Rubbellos!",
		scratch_title: "Rubbel das Los",
		scratch_button: "Rubbeln",
		next_lottery_button: "NÃ¤chste Lotterie",
		reset_button: "ZurÃ¼cksetzen",
		probability_label: "Gewinnwahrscheinlichkeit (%) einstellen",
		apply_probability_button: "Wahrscheinlichkeit anwenden",
		jackpot_modal_title: "Gewinnresultat",
		cost_summary_title: "KostenÃ¼bersicht",
		currency_symbol: "â‚¬",
		scratch_here: "Bitte rubbeln Sie die Lotterie!",
		scratch_label: "Rubbel!",
		winning_message: "Herzlichen GlÃ¼ckwunsch!",
		no_luck: "Keine GlÃ¼ck!",
		lottery_logs: "Loterieprotokolle",
	},
	it: {
		flag: "ğŸ‡®ğŸ‡¹",
		header_title: "Simulazione Lotteria",
		header_desc: "Metti alla prova la tua fortuna con un gratta e vinci!",
		scratch_title: "Gratta la Lotteria",
		scratch_button: "Gratta",
		next_lottery_button: "Prossima Lotteria",
		reset_button: "Ripristina",
		probability_label: "Imposta ProbabilitÃ  di Vincita (%)",
		apply_probability_button: "Applica ProbabilitÃ ",
		jackpot_modal_title: "Risultato della Vincita",
		cost_summary_title: "Riepilogo Costi",
		currency_symbol: "â‚¬",
		scratch_here: "Per favore gratta la lotteria!",
		scratch_label: "Gratta!",
		winning_message: "Congratulazioni!",
		no_luck: "Nessuna fortuna!",
		lottery_logs: "Registri della Lotteria",
	},
	vi: {
		flag: "ğŸ‡»ğŸ‡³",
		header_title: "MÃ´ Phá»ng Xá»• Sá»‘",
		header_desc: "HÃ£y thá»­ váº­n may cá»§a báº¡n vá»›i xá»• sá»‘ cÃ o!",
		scratch_title: "CÃ o Xá»• Sá»‘",
		scratch_button: "CÃ o",
		next_lottery_button: "Xá»• Sá»‘ Tiáº¿p Theo",
		reset_button: "Äáº·t Láº¡i",
		probability_label: "Äáº·t XÃ¡c Suáº¥t TrÃºng (%)",
		apply_probability_button: "Ãp Dá»¥ng XÃ¡c Suáº¥t",
		jackpot_modal_title: "Káº¿t Quáº£ Tháº¯ng",
		cost_summary_title: "TÃ³m Táº¯t Chi PhÃ­",
		currency_symbol: "â‚«",
		scratch_here: "Vui lÃ²ng cÃ o xá»• sá»‘!",
		scratch_label: "CÃ o!",
		winning_message: "ChÃºc má»«ng!",
		no_luck: "KhÃ´ng cÃ³ váº­n may!",
		lottery_logs: "Nháº­t kÃ½ xá»• sá»‘",
	},
	ko: {
		flag: "ğŸ‡°ğŸ‡·",
		header_title: "ìŠ¤í¬ë˜ì¹˜ ë³µê¶Œ ì‹œë®¬ë ˆì´ì…˜",
		header_desc: "ë³µê¶Œìœ¼ë¡œ ë‹¹ì‹ ì˜ ìš´ì„ ì‹œí—˜í•´ë³´ì„¸ìš”!",
		scratch_title: "ë³µê¶Œ ê¸ê¸°",
		scratch_button: "ê¸ê¸°",
		next_lottery_button: "ë‹¤ìŒ ë³µê¶Œ",
		reset_button: "ì´ˆê¸°í™”",
		probability_label: "ë‹¹ì²¨ í™•ë¥  ì„¤ì • (%)",
		apply_probability_button: "í™•ë¥  ì ìš©",
		jackpot_modal_title: "ë‹¹ì²¨ ê²°ê³¼",
		cost_summary_title: "ë¹„ìš© ìš”ì•½",
		currency_symbol: "â‚©",
		scratch_here: "ì—¬ê¸°ë¥¼ ê¸ì–´ë³´ì„¸ìš”!",
		scratch_label: "ë³µê¶Œì„ ê¸ì–´ì£¼ì„¸ìš”!",
		winning_message: "ì¶•í•˜í•©ë‹ˆë‹¤!",
		no_luck: "ìš´ì´ ì—†ë„¤ìš”!",
		lottery_logs: "ë³µê¶Œ ê¸°ë¡",
	},
	ru: {
		flag: "ğŸ‡·ğŸ‡º",
		header_title: "Ğ¡Ğ¸Ğ¼ÑƒĞ»ÑÑ†Ğ¸Ñ Ğ›Ğ¾Ñ‚ĞµÑ€ĞµĞ¸",
		header_desc: "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ÑĞ²Ğ¾Ñ ÑƒĞ´Ğ°Ñ‡Ñƒ Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¾Ğ¹-ÑĞºÑ€ĞµÑ‚Ñ‡ĞµĞ¼!",
		scratch_title: "Ğ¡Ğ¾Ñ‚Ñ€Ğ¸ Ğ›Ğ¾Ñ‚ĞµÑ€ĞµÑ",
		scratch_button: "Ğ¡Ñ‚ĞµÑ€ĞµÑ‚ÑŒ",
		next_lottery_button: "Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ°Ñ Ğ›Ğ¾Ñ‚ĞµÑ€ĞµÑ",
		reset_button: "Ğ¡Ğ±Ñ€Ğ¾Ñ",
		probability_label: "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ’Ñ‹Ğ¸Ğ³Ñ€Ñ‹ÑˆĞ° (%)",
		apply_probability_button: "ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ",
		jackpot_modal_title: "Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ’Ñ‹Ğ¸Ğ³Ñ€Ñ‹ÑˆĞ°",
		cost_summary_title: "Ğ¡Ğ²Ğ¾Ğ´ĞºĞ° Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸",
		currency_symbol: "â‚½",
		scratch_here: "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑĞ¾Ñ‚Ñ€Ğ¸ Ğ»Ğ¾Ñ‚ĞµÑ€ĞµÑ!",
		scratch_label: "Ğ¡Ğ¾Ñ‚Ñ€Ğ¸!",
		winning_message: "ĞŸĞ¾Ğ·Ğ´Ñ€Ğ°Ğ²Ğ»ÑÑ!",
		no_luck: "ĞĞµÑ‚ ÑƒĞ´Ğ°Ñ‡Ğ¸!",
		lottery_logs: "Ğ–ÑƒÑ€Ğ½Ğ°Ğ»Ñ‹ Ğ›Ğ¾Ñ‚ĞµÑ€ĞµĞ¸",
	},
	ja: {
		flag: "ğŸ‡¯ğŸ‡µ",
		header_title: "ã‚¹ã‚¯ãƒ©ãƒƒãƒãã˜ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
		header_desc: "ãã˜ã‚’ã‚¹ã‚¯ãƒ©ãƒƒãƒã—ã¦é‹è©¦ã—",
		scratch_title: "ãã˜ã‚’ã‚¹ã‚¯ãƒ©ãƒƒãƒ",
		scratch_button: "ã‚¹ã‚¯ãƒ©ãƒƒãƒ",
		next_lottery_button: "æ¬¡ã®ãã˜",
		reset_button: "ãƒªã‚»ãƒƒãƒˆ",
		probability_label: "å½“é¸ç¢ºç‡ (%) è¨­å®š",
		apply_probability_button: "ç¢ºç‡ã‚’é©ç”¨",
		jackpot_modal_title: "å½“é¸çµæœ",
		cost_summary_title: "ã‚³ã‚¹ãƒˆã‚µãƒãƒªãƒ¼",
		currency_symbol: "Â¥",
		scratch_here: "å®ãã˜ã‚’ã‚¹ã‚¯ãƒ©ãƒƒãƒã—ã¦ãã ã•ã„ï¼",
		scratch_label: "ã‚¹ã‚¯ãƒ©ãƒƒãƒï¼",
		winning_message: "ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼",
		no_luck: "é‹ãŒã‚ã‚Šã¾ã›ã‚“ï¼",
		lottery_logs: "å®ãã˜è¨˜éŒ²",
	},
	fr: {
		flag: "ğŸ‡«ğŸ‡·",
		header_title: "Simulation de Loterie",
		header_desc: "Testez votre chance avec un ticket Ã  gratter !",
		scratch_title: "Gratter la Loterie",
		scratch_button: "Gratter",
		next_lottery_button: "Prochaine Loterie",
		reset_button: "reset",
		probability_label: "DÃ©finir la ProbabilitÃ© de Gagner (%)",
		apply_probability_button: "Appliquer la ProbabilitÃ©",
		jackpot_modal_title: "RÃ©sultat du Jackpot",
		cost_summary_title: "RÃ©sumÃ© des CoÃ»ts",
		currency_symbol: "â‚¬",
		scratch_here: "Veuillez gratter la loterie !",
		scratch_label: "Gratter!",
		winning_message: "FÃ©licitations!",
		no_luck: "Pas de chance!",
		lottery_logs: "Journaux de Loterie",
	},
}

let lang = "en" // ì´ˆê¸° ì–¸ì–´ ì„¤ì •
let currencySymbol = translations[lang].currency_symbol || "$" // ì´ˆê¸° í†µí™” ê¸°í˜¸ ì„¤ì •
let scratch_here = translations[lang].scratch_here || "Scratch here!" // ì´ˆê¸° ê¸ê¸° ë©”ì‹œì§€ ì„¤ì •
let scratch_label = translations[lang].scratch_label || "Scratch!" // ì´ˆê¸° ë³µê¶Œ ì•ˆë‚´ ë¬¸
let winning_message = translations[lang].winning_message || "Congratulations!" // ì´ˆê¸° ë³µê¶Œ ì•ˆë‚´ ë¬¸
let no_luck = translations[lang].no_luck || "No luck!" // ì´ˆê¸° ê½ ì•ˆë‚´ ë¬¸
let lottery_logs = translations[lang].lottery_logs || "Lottery logs"
let flag = translations[lang].flag || "us" // ì´ˆê¸° ï¿½ï¿½ï¿½ï¿½ ì„¤ì •

document.getElementById("languageSelector").addEventListener("click", () => {
	document.getElementById("languageMenu").style.display = "flex"
	document.getElementById("langBtn").style.display = "none"
})

document.querySelectorAll("#languageMenu a").forEach((link) => {
	link.addEventListener("click", (e) => {
		e.preventDefault()
		const selectedLang = e.target.getAttribute("data-lang")
		changeLanguage(selectedLang)
	})
})

function changeLanguage(selectedLang) {
	// ì–¸ì–´ë¥¼ ë³€ê²½í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë¶€ë¶„
	const elements = document.querySelectorAll("[data-translate]")
	elements.forEach((element) => {
		const key = element.getAttribute("data-translate")
		element.textContent = translations[selectedLang][key] || key
	})

	// ë³€ê²½ëœ ì–¸ì–´ì— ë”°ë¥¸ í†µí™” ê¸°í˜¸ì™€ ê¸ê¸° ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
	lang = selectedLang
	currencySymbol = translations[selectedLang].currency_symbol || "$"
	scratch_here = translations[selectedLang].scratch_here || "Scratch here!"
	scratch_label = translations[selectedLang].scratch_label || "Scratch!" // ì´ˆê¸° ë³µê¶Œ ì•ˆë‚´ ë¬¸
	winning_message = translations[selectedLang].winning_message || "Congratulations!" // ì´ˆê¸° ë³µê¶Œ ì•ˆë‚´ ë¬¸
	no_luck = translations[selectedLang].no_luck || "No luck!" // ì´ˆê¸° ê½ ì•ˆë‚´ ë¬¸
	lottery_logs = translations[selectedLang].lottery_logs || "Lottery logs"
	flag = translations[selectedLang].flag
	resetLottery()
	displayLotteryRecord()
	updateDisplay()
	// ìº”ë²„ìŠ¤ ì´ˆê¸°í™” (ìº”ë²„ìŠ¤ì— í‘œì‹œë˜ëŠ” ë¬¸êµ¬ë„ ì–¸ì–´ì— ë”°ë¼ ë³€ê²½ë˜ë„ë¡)
	initCanvas()

	document.getElementById("languageSelector").innerText = flag
	// ì–¸ì–´ ë©”ë‰´ ìˆ¨ê¹€
	document.getElementById("languageMenu").style.display = "none"
	document.getElementById("langBtn").style.display = "flex"
}

// ëª¨ë‹¬ ìš”ì†Œ
// ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ ì„ íƒ
const modal = document.getElementById("jackpotModal")
const closeModal = document.querySelector(".modal .close")
const jackpotMessage = document.getElementById("jackpotMessage")
const prizeVTScroll = document.getElementById("prizeVTScroll")
/* ìŠ¤í¬ë˜ì¹˜ ì»¤ë²„ ë§Œë“¤ê¸° ì‹œì‘ */
let p1 = "0.00002" // user-setting probability
const $canvas = document.getElementById("greyCover")
const context = $canvas.getContext("2d")
const WIDTH = 320
const HEIGHT = 200
const dpr = window.devicePixelRatio

const ERASE_RADIUS = 30
const ERASE_DISTANCE = ERASE_RADIUS / 2

const col = Math.ceil(WIDTH / (ERASE_RADIUS * 2 + ERASE_DISTANCE))
const row = Math.ceil(HEIGHT / (ERASE_RADIUS * 2 + ERASE_DISTANCE))

let thresholdOfEraseCount = col * row
let erasedList = []
let isDrawing = false
let isRevealed = false
let isPrizeAwarded = false

const initCanvas = () => {
	$canvas.style.width = `${WIDTH}px`
	$canvas.style.height = `${HEIGHT}px`
	$canvas.width = WIDTH * dpr
	$canvas.height = HEIGHT * dpr
	context.scale(dpr, dpr)

	context.strokeStyle = "#999"
	context.fillStyle = "#999"
	context.beginPath()
	context.roundRect(0, 0, WIDTH, HEIGHT, 8)
	context.stroke()
	context.fill()

	context.font = "1rem neodgm"
	context.fillStyle = "#000"
	context.textAlign = "center"
	context.textBaseline = "middle"
	context.fillText(`${scratch_here}`, WIDTH / 2, HEIGHT / 2)
}

initCanvas()

const { top: canvasTop, left: canvasLeft } = $canvas.getBoundingClientRect()

const drawTransparentCircle = (x, y) => {
	context.save()
	context.globalCompositeOperation = "destination-out"
	context.beginPath()
	context.arc(x, y, ERASE_RADIUS, 0, 2 * Math.PI, false)
	context.fill()
	context.closePath()
	context.restore()

	const checkList = erasedList.filter(({ x: posX, y: posY }) => {
		const distX = posX - x
		const distY = posY - y
		return Math.sqrt(distX * distX + distY * distY) < ERASE_RADIUS + ERASE_DISTANCE
	})

	if (!checkList.length) {
		erasedList.push({ x, y })
	}
}

const handleDrawingStart = (event) => {
	isDrawing = true
	const { offsetX, offsetY } = getMouseOrTouchPosition(event)
	drawTransparentCircle(offsetX, offsetY)
	// í„°ì¹˜ê°€ ì‹œì‘ë  ë•Œ ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™”
	document.body.style.overflow = "hidden"
}

const handleDrawing = (event) => {
	if (!isDrawing) return
	const { offsetX, offsetY } = getMouseOrTouchPosition(event)
	drawTransparentCircle(offsetX, offsetY)

	if (erasedList.length >= thresholdOfEraseCount) {
		if (!isRevealed && !isPrizeAwarded) {
			context.clearRect(0, 0, WIDTH, HEIGHT)
			isRevealed = true
			isPrizeAwarded = true
			totalCost += 1000
			updateDisplay()
			showJackpotModal(jackpotLevel)
		}
	}
}

const handleDrawingEnd = () => {
	isDrawing = false
	// í„°ì¹˜ê°€ ëë‚˜ë©´ ìŠ¤í¬ë¡¤ í™œì„±í™”
	document.body.style.overflow = "auto"
}

const getMouseOrTouchPosition = (event) => {
	let offsetX, offsetY
	if (event.touches) {
		const touch = event.touches[0]
		offsetX = touch.pageX - canvasLeft
		offsetY = touch.pageY - canvasTop
	} else {
		offsetX = event.offsetX
		offsetY = event.offsetY
	}
	return { offsetX, offsetY }
}

// ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€
$canvas.addEventListener("mousedown", handleDrawingStart)
$canvas.addEventListener("mousemove", handleDrawing)
$canvas.addEventListener("mouseup", handleDrawingEnd)

// í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
$canvas.addEventListener("touchstart", handleDrawingStart)
$canvas.addEventListener("touchmove", handleDrawing)
$canvas.addEventListener("touchend", handleDrawingEnd)

/* ìŠ¤í¬ë˜ì¹˜ ì»¤ë²„ ë§Œë“¤ê¸° ë */
function calculatePrizeProbabilities(P1) {
	const remainingProbability = 1 - parseFloat(P1) // ë‚˜ë¨¸ì§€ í™•ë¥ 
	const fibonacci = [1, 2, 3, 5, 8, 13, 21, 34] // 1ë‹¨ê³„ë¥¼ ì œì™¸í•œ í”¼ë³´ë‚˜ì¹˜ìˆ˜ì—´
	const T = fibonacci.reduce((sum, f) => sum + f, 0) // í”¼ë³´ë‚˜ì¹˜ ìˆ˜ì—´ì˜ ì´í•©

	const probabilities = fibonacci.map((f, index) => {
		// ê° ë“±ìˆ˜ë³„ ë‹¹ì²¨í™•ë¥  ê³„ì‚°í•´ì„œ ë°°ì—´ì— ì €ì¥
		// 1ë“±ì˜ í™•ë¥ ì€ P1ë¡œ ì„¤ì •
		if (index === 0) {
			return P1
		} else {
			// 2ë“±ë¶€í„°ì˜ í™•ë¥  ê³„ì‚°
			return P1 + (remainingProbability * f) / T
		}
	})

	// í™•ë¥  ì ìš©
	for (let i = 0; i < prizeThresholds.length; i++) {
		prizeThresholds[i].threshold = probabilities[i]
	}
}

// ë“±ìˆ˜ë³„ í™•ë¥ ê³„ì‚°
let prizeThresholds = [
	{ rank: 1, rewardMoney: 1000000000, threshold: 0.2 }, // 1ë“± 20% í™•ë¥ 
	{ rank: 2, rewardMoney: 100000000, threshold: 0.2113 }, // 2ë“± 21.13% í™•ë¥ 
	{ rank: 3, rewardMoney: 11000000, threshold: 0.217 }, // 3ë“± 21.70% í™•ë¥ 
	{ rank: 4, rewardMoney: 20000, threshold: 0.284 }, // 4ë“± 22.84% í™•ë¥ 
	{ rank: 5, rewardMoney: 4000, threshold: 0.2452 }, // 5ë“± 24.52% í™•ë¥ 
	{ rank: 6, rewardMoney: 2000, threshold: 0.2738 }, // 6ë“± 27.38% í™•ë¥ 
	{ rank: 7, rewardMoney: 1000, threshold: 0.3191 }, // 7ë“± 31.91% í™•ë¥ 
	{ rank: 8, rewardMoney: 500, threshold: 0.3926 }, // 8ë“± 39.26% í™•ë¥ 
]

function getRandomPrize(prizeThresholds) {
	// ê° ë“±ìˆ˜ì˜ thresholdì— ëŒ€í•´ ëœë¤ í•¨ìˆ˜ë¥¼ ì ìš©
	for (let i = 0; i < prizeThresholds.length; i++) {
		const threshold = prizeThresholds[i].threshold
		const randomNumber = Math.random() // 0ê³¼ 1 ì‚¬ì´ì˜ ëœë¤ ìˆ«ì ìƒì„±
		if (randomNumber < threshold) {
			// ë‹¹ì²¨ëœ ê²½ìš°
			jackpot[i].rank = prizeThresholds[i].rank
			jackpot[i].jackpot = 1
		} else {
			// ë‹¹ì²¨ì•ˆëœ ê²½ìš°
			jackpot[i].rank = prizeThresholds[i].rank
			jackpot[i].jackpot = 0
		}
	}
}

// ë‹¹ì²¨ê²°ê³¼ë¥¼ ë‹´ì„ jackopt
let jackpot = [
	{ rank: 1, num: 10, rewardMoney: 1000000000, jackpot: 0 }, // 1ë“± 20% í™•ë¥ 
	{ rank: 2, num: 8, rewardMoney: 100000000, jackpot: 0 }, // 2ë“± 21.13% í™•ë¥ 
	{ rank: 3, num: 7, rewardMoney: 11000000, jackpot: 0 }, // 3ë“± 21.70% í™•ë¥ 
	{ rank: 4, num: 6, rewardMoney: 20000, jackpot: 0 }, // 4ë“± 22.84% í™•ë¥ 
	{ rank: 5, num: 5, rewardMoney: 4000, jackpot: 0 }, // 5ë“± 24.52% í™•ë¥ 
	{ rank: 6, num: 4, rewardMoney: 2000, jackpot: 0 }, // 6ë“± 27.38% í™•ë¥ 
	{ rank: 7, num: 3, rewardMoney: 1000, jackpot: 0 }, // 7ë“± 31.91% í™•ë¥ 
	{ rank: 8, num: 2, rewardMoney: 500, jackpot: 0 }, // 8ë“± 39.26% í™•ë¥ 
]

// ê°€ì¥ ë†’ì€ ë“±ìˆ˜ ì¶”ì¶œ
function findLowestRankWithJackpotOne(jackpot) {
	// jackpot ê°’ì´ 1ì¸ ê°ì²´ë“¤ë§Œ í•„í„°ë§
	const filteredPrizes = jackpot.filter((prize) => prize.jackpot === 1)
	// jackpot ê°’ì´ 1ì¸ ê°ì²´ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ null ë°˜í™˜
	if (filteredPrizes.length === 0) {
		return null
	}

	// rank 8ì¸ ê°ì²´ë§Œ jackpot ê°’ì´ 1ì¸ ê²½ìš°
	const rank8Prize = filteredPrizes.find((prize) => prize.rank === 8)
	if (filteredPrizes.length === 1 && rank8Prize) {
		return rank8Prize
	}

	// rankê°€ ì—°ì†ì ìœ¼ë¡œ ì¦ê°€í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
	const isConsecutiveRanks = (prizes) => {
		const sortedPrizes = prizes.slice().sort((a, b) => a.rank - b.rank)
		for (let i = 1; i < sortedPrizes.length; i++) {
			if (sortedPrizes[i].rank !== sortedPrizes[i - 1].rank + 1) {
				return false
			}
		}
		return true
	}

	// rankê°€ 8ì¸ ê°ì²´ë¥¼ í¬í•¨í•˜ê³ , ëª¨ë“  rankê°€ ì—°ì†ì ìœ¼ë¡œ ì¦ê°€í•˜ëŠ”ì§€ í™•ì¸
	if (rank8Prize && isConsecutiveRanks(filteredPrizes)) {
		// ê°€ì¥ ë‚®ì€ rank ê°’ì„ ê°€ì§„ ê°ì²´ ì°¾ê¸°
		const lowestRankPrize = filteredPrizes.reduce((min, prize) => {
			return prize.rank < min.rank ? prize : min
		})
		return lowestRankPrize
	}

	// ìœ„ ì¡°ê±´ì— ë§ì§€ ì•ŠëŠ” ê²½ìš° null ë°˜í™˜
	return null
}

const numSup = { 1: "I", 2: "II", 3: "III", 4: "IV", 5: "V", 6: "VI", 7: "VII", 8: "VIII", 9: "IX", 0: "Ã˜" }

function populateGridCells(jackpotLevel) {
	const gridCells = document.querySelectorAll(".grid-cell") // 10ê°œì˜ ê·¸ë¦¬ë“œì…€ì„ ì„ íƒ
	const availableNumbers = Array.from({ length: 10 }, (_, i) => i) // 0ë¶€í„° 9ê¹Œì§€ì˜ ìˆ«ì ë°°ì—´

	if (jackpotLevel) {
		// ë‹¹ì²¨ëœ ê²½ìš°
		const chosenNumber = Math.floor(Math.random() * 10) // 0~9 ì¤‘ ëœë¤í•œ ìˆ«ì ì„ íƒ
		const chosenIndices = [] // ì„ íƒëœ ì…€ì˜ ì¸ë±ìŠ¤ë¥¼ ì €ì¥

		// jackpotLevel.numì˜ ìˆ˜ë§Œí¼ ê·¸ë¦¬ë“œ ì…€ì— chosenNumber ë°°ì¹˜
		for (let i = 0; i < jackpotLevel.num; i++) {
			let randomIndex
			do {
				randomIndex = Math.floor(Math.random() * gridCells.length)
			} while (chosenIndices.includes(randomIndex)) // ì¤‘ë³µëœ ì¸ë±ìŠ¤ê°€ ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ì²˜ë¦¬

			gridCells[randomIndex].innerHTML = `<span>${chosenNumber}<sup>${numSup[chosenNumber]}</sup></span>` // ì„ íƒëœ ìˆ«ì ì‚½ì…
			gridCells[randomIndex].classList.add("chosen")

			chosenIndices.push(randomIndex) // ì„ íƒëœ ì¸ë±ìŠ¤ ì €ì¥
		}

		// ë‚˜ë¨¸ì§€ ì…€ì— ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ìˆ«ìë“¤ ë°°ì¹˜
		const remainingNumbers = availableNumbers.filter((num) => num !== chosenNumber) // chosenNumber ì œì™¸í•œ ìˆ«ìë“¤
		let remainingIndex = 0
		for (let i = 0; i < gridCells.length; i++) {
			if (!chosenIndices.includes(i)) {
				gridCells[i].innerHTML = `<span>${remainingNumbers[remainingIndex]}<sup>${numSup[remainingNumbers[remainingIndex]]}</sup></span>`
				gridCells[i].classList.remove("chosen")
				remainingIndex++
			}
		}
	} else {
		// ë‹¹ì²¨ë˜ì§€ ì•Šì€ ê²½ìš°: ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ìˆ«ìë“¤ë§Œ ëœë¤í•˜ê²Œ ë°°ì¹˜
		availableNumbers.sort(() => Math.random() - 0.5) // ìˆ«ìë“¤ì„ ëœë¤í•˜ê²Œ ì„ê¸°

		for (let i = 0; i < gridCells.length; i++) {
			gridCells[i].innerHTML = `<span>${availableNumbers[i]}<sup>${numSup[availableNumbers[i]]}</sup></span>`
			gridCells[i].classList.remove("chosen")
		}
	}
}

function displayPrizeProbabilities(prizeThresholds) {
	// 'div.prize-tier' ìš”ì†Œ ì„ íƒ
	const prizeTierDiv = document.querySelector("div.prize-tier")

	// ê¸°ì¡´ ë‚´ìš©ì„ ì œê±°
	prizeTierDiv.innerHTML = ""

	// í…Œì´ë¸” ìƒì„±
	const table = document.createElement("table")
	table.setAttribute("class", "prize-table")

	// í…Œì´ë¸” í—¤ë” ìƒì„±
	const thead = document.createElement("thead")
	const headerRow = document.createElement("tr")
	const rankHeader = document.createElement("th")
	rankHeader.textContent = "Prize"
	const probabilityHeader = document.createElement("th")
	probabilityHeader.textContent = "Probability"
	const rewardHeader = document.createElement("th")
	rewardHeader.innerHTML = "Reward"

	headerRow.appendChild(rankHeader)
	headerRow.appendChild(probabilityHeader)
	headerRow.appendChild(rewardHeader)
	thead.appendChild(headerRow)
	table.appendChild(thead)

	// í…Œì´ë¸” ë°”ë”” ìƒì„±
	const tbody = document.createElement("tbody")

	// prizeThresholds ë°ì´í„°ë¥¼ ìˆœíšŒí•˜ë©´ì„œ ê° ë“±ìˆ˜ì™€ í™•ë¥  ë° ë‹¹ì²¨ê¸ˆì„ í…Œì´ë¸”ì— ì¶”ê°€
	prizeThresholds.forEach((tier) => {
		const row = document.createElement("tr")

		const rankCell = document.createElement("td")
		rankCell.textContent = `${tier.rank}`

		const probabilityCell = document.createElement("td")
		const probability = tier.threshold * 100
		const formattedProbability = probability % 1 === 0 ? probability.toFixed(0) : probability.toString().split(".")[1]?.length > 10 ? probability.toFixed(10) : probability

		probabilityCell.textContent = `${formattedProbability}%`

		const rewardCell = document.createElement("td")
		rewardCell.innerHTML = `${currencySymbol} ${tier.rewardMoney.toLocaleString()}` // ê¸ˆì•¡ì„ ì²œ ë‹¨ìœ„ë¡œ êµ¬ë¶„í•˜ì—¬ í‘œì‹œ

		row.appendChild(rankCell)
		row.appendChild(probabilityCell)
		row.appendChild(rewardCell)
		tbody.appendChild(row)
	})

	table.appendChild(tbody)
	prizeTierDiv.appendChild(table) // ìƒì„±í•œ í…Œì´ë¸”ì„ 'div.prize-tier'ì— ì¶”ê°€
}

// ë“±ìˆ˜ë³„ ë‹¹ì²¨í™•ë¥ ê³„ì‚°
calculatePrizeProbabilities(p1) // 20% ë‹¹ì²¨í™•ë¥  ì…ë ¥ ì´ˆê¸°ê°’
// ê° ë‹¹ì²¨í™•ë¥ ì„ ì ìš©í•˜ì—¬ ê° ë“±ìˆ˜ë³„ ì¶”ì²¨í•˜ì—¬ jackpotì— ê¸°ë¡
getRandomPrize(prizeThresholds)
// ê°€ì¥ ë†’ì€ ë“±ìˆ˜ ì¶”ì¶œ
let jackpotLevel = findLowestRankWithJackpotOne(jackpot)
// ì˜ˆì‹œ: jackpotLevelì„ ì–»ê³  ê·¸ë¦¬ë“œì…€ì— ìˆ«ìë¥¼ ë°°ì¹˜
populateGridCells(jackpotLevel)

displayPrizeProbabilities(prizeThresholds)
applyProbability()

function applyProbability() {
	const probabilityInput = document.getElementById("probabilityInput").value
	// ì‚¬ìš©ì ì…ë ¥ê°’ì„ calculatePrizeProbabilities í•¨ìˆ˜ì— ì „ë‹¬
	p1 = parseFloat(probabilityInput) / 100
	if (isNaN(p1) || p1 <= 0 || p1 >= 1) {
		alert("Input valid integer value (0~99)")
		return
	}

	// ìƒˆë¡œìš´ í™•ë¥ ë¡œ ë‹¹ì²¨ í™•ë¥  ê³„ì‚°
	calculatePrizeProbabilities(p1)
	getRandomPrize(prizeThresholds)
	// ê°€ì¥ ë†’ì€ ë“±ìˆ˜ ì¶”ì¶œ
	jackpotLevel = findLowestRankWithJackpotOne(jackpot)
	// ì˜ˆì‹œ: jackpotLevelì„ ì–»ê³  ê·¸ë¦¬ë“œì…€ì— ìˆ«ìë¥¼ ë°°ì¹˜
	populateGridCells(jackpotLevel)
	// ì—…ë°ì´íŠ¸ëœ í™•ë¥ ë¡œ ë‹¹ì²¨ í™•ë¥ í‘œ ì—…ë°ì´íŠ¸
	displayPrizeProbabilities(prizeThresholds)

	// ë‹¤ìŒ ë³µê¶Œ ì¤€ë¹„
	initCanvas()
	erasedList = []
	isRevealed = false
	isDrawing = false // ë³µê¶Œ ê¸ê¸° ìƒíƒœ ì´ˆê¸°í™”
	isPrizeAwarded = false

	closeJackpotModal()
}

// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€: ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰
document.getElementById("applyProbability").addEventListener("click", applyProbability)

function updateDisplay() {
	const costDisplay = document.getElementById("costDisplay")
	const prizeDisplay = document.getElementById("prizeDisplay")
	const profitDisplay = document.getElementById("profitDisplay")

	// ì´ ë¹„ìš© í‘œì‹œ
	if (!costDisplay) {
		const newCostDisplay = document.createElement("div")
		newCostDisplay.id = "costDisplay"
		newCostDisplay.textContent = `Total Cost: ${currencySymbol} ${totalCost.toLocaleString()}`
		document.getElementById("lotteryBalance").appendChild(newCostDisplay)
	} else {
		costDisplay.textContent = `Total Cost: ${currencySymbol} ${totalCost.toLocaleString()}`
	}

	// ì´ ë‹¹ì²¨ê¸ˆì•¡ í‘œì‹œ
	if (!prizeDisplay) {
		const newPrizeDisplay = document.createElement("div")
		newPrizeDisplay.id = "prizeDisplay"
		newPrizeDisplay.textContent = `Total Prize: ${currencySymbol} ${totalPrize.toLocaleString()}`
		document.getElementById("lotteryBalance").appendChild(newPrizeDisplay)
	} else {
		prizeDisplay.textContent = `Total Prize: ${currencySymbol} ${totalPrize.toLocaleString()}`
	}

	// ì´ ì†ìµ ê³„ì‚° ë° í‘œì‹œ
	const totalProfit = totalPrize - totalCost
	if (!profitDisplay) {
		const newProfitDisplay = document.createElement("div")
		newProfitDisplay.id = "profitDisplay"
		newProfitDisplay.textContent = `Total Profit: ${currencySymbol} ${totalProfit.toLocaleString()}`
		document.getElementById("lotteryBalance").appendChild(newProfitDisplay)
	} else {
		profitDisplay.textContent = `Total Profit: ${currencySymbol} ${totalProfit.toLocaleString()}`
	}
}

let totalAttempts = 0 // ì´ ì‹œë„ íšŸìˆ˜

// ëª¨ë‹¬ì„ í‘œì‹œí•˜ê³  ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
function showJackpotModal(jackpotLevel) {
	totalAttempts++ // ì‹œë„ íšŸìˆ˜ ì¦ê°€
	updateDisplay()
	updateLotteryRecord(jackpotLevel)
	const totalProfit = totalPrize - totalCost // ì´ ì†ìµ ê³„ì‚°
	if (jackpotLevel) {
		jackpotMessage.innerHTML = `${winning_message}<br>${jackpotLevel.rank} Prize!<br>
                                    <span>${currencySymbol} ${jackpotLevel.rewardMoney.toLocaleString()}!</span>
                                    <br> Total Profit: ${currencySymbol} ${totalProfit.toLocaleString()}<br>
                                    Total attempts: ${totalAttempts}`
		totalPrize += jackpotLevel.rewardMoney
	} else {
		jackpotMessage.innerHTML = `${no_luck}<br> Total Profit: ${currencySymbol} ${totalProfit.toLocaleString()}<br>
                                    Total attempts: ${totalAttempts}`
	}

	isRevealed = true
	modal.style.display = "flex"
}

// ëª¨ë‹¬ì„ ë‹«ëŠ” í•¨ìˆ˜
function closeJackpotModal() {
	modal.style.display = "none"
}

// ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
closeModal.addEventListener("click", closeJackpotModal)

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
window.addEventListener("click", (event) => {
	if (event.target === modal) {
		closeJackpotModal()
	}
})

// ëª¨ë‹¬ ìš”ì†Œ ë

// ë³µê¶Œ ê¸ê¸° ë²„íŠ¼
const $scratchButton = document.getElementById("scratch")
$scratchButton.addEventListener("click", () => {
	if (!isDrawing && !isPrizeAwarded) {
		// ê¸ê¸° ì‹œì‘
		isDrawing = true
		context.clearRect(0, 0, WIDTH, HEIGHT)
		isRevealed = true
		isPrizeAwarded = true
		totalCost += 1000 // í•œ ë²ˆ ê¸ê¸° ë‹¹ 1000ì› ë¹„ìš© ì¶”ê°€
		// í˜„ì¬ ì´ ë¹„ìš©ê³¼ ë‹¹ì²¨ê¸ˆì•¡ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
		updateDisplay()
		// ëª¨ë‹¬ í‘œì‹œ
		showJackpotModal(jackpotLevel)
		// ê¸ê¸° ë¹„ìš© ì¶”ê°€
	}
})

let totalCost = 0 // ì´ ë¹„ìš©
let totalPrize = 0 // ì´ ë‹¹ì²¨ê¸ˆ

// ë¦¬ì…‹ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function resetLottery() {
	initCanvas()
	lotteryRecord = [] // ê¸°ë¡ ì´ˆê¸°í™”
	totalAttempts = 0 // ì´ ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
	erasedList = []

	totalCost = 0 // ì´ ë¹„ìš©
	totalPrize = 0 // ì´ ë‹¹ì²¨ê¸ˆ

	isRevealed = false
	isDrawing = false // ë³µê¶Œ ê¸ê¸° ìƒíƒœ ì´ˆê¸°í™”
	isPrizeAwarded = false
	prizeVTScroll.innerHTML = ``
	updateDisplay()

	document.getElementById("costDisplay").innerHTML = `Total Cost: ${currencySymbol} 0`
	document.getElementById("prizeDisplay").innerHTML = `Total Prize: ${currencySymbol} 0`
	document.getElementById("profitDisplay").innerHTML = `Total Profit: ${currencySymbol} 0`

	document.getElementById("recordDisplay").innerHTML = `<h3>Lottery Logs</h3>`
	// ìƒˆë¡œìš´ í™•ë¥ ë¡œ ë‹¹ì²¨ í™•ë¥  ê³„ì‚°
	calculatePrizeProbabilities(p1)
	// ìƒˆ ë³µê¶Œì„ ìœ„í•œ ìƒˆë¡œìš´ ë‹¹ì²¨ë²ˆí˜¸ ìƒì„±
	getRandomPrize(prizeThresholds)

	jackpotLevel = findLowestRankWithJackpotOne(jackpot)
	populateGridCells(jackpotLevel)
	displayPrizeProbabilities(prizeThresholds)
	closeJackpotModal()
}

document.getElementById("resetLottery").addEventListener("click", resetLottery)

document.getElementById("nextLottery").onclick = () => {
	if (!isRevealed) {
		alert(scratch_label)
	} else {
		// ë‹¤ìŒ ë³µê¶Œ ì¤€ë¹„
		initCanvas()
		erasedList = []
		isRevealed = false
		isDrawing = false // ë³µê¶Œ ê¸ê¸° ìƒíƒœ ì´ˆê¸°í™”
		isPrizeAwarded = false

		// ìƒˆ ë³µê¶Œì„ ìœ„í•œ ìƒˆë¡œìš´ ë‹¹ì²¨ë²ˆí˜¸ ìƒì„±
		getRandomPrize(prizeThresholds)

		jackpotLevel = findLowestRankWithJackpotOne(jackpot)
		populateGridCells(jackpotLevel)

		// í™”ë©´ ì—…ë°ì´íŠ¸
		updateDisplay()
		// ë‹¹ì²¨ìœ¨í‘œ í‘œì‹œ
		displayPrizeProbabilities(prizeThresholds)
	}
	closeJackpotModal()
}

let lotteryRecord = []

function updateLotteryRecord(jackpotLevel) {
	const currentTime = new Date() // í˜„ì¬ ì‹œê°
	const month = String(currentTime.getMonth() + 1).padStart(2, "0") // ì›” (0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1 í•„ìš”)
	const day = String(currentTime.getDate()).padStart(2, "0") // ì¼
	const hours = String(currentTime.getHours()).padStart(2, "0") // ì‹œ (24ì‹œê°„ í˜•ì‹)
	const minutes = String(currentTime.getMinutes()).padStart(2, "0") // ë¶„
	const seconds = String(currentTime.getSeconds()).padStart(2, "0") // ì´ˆ

	const formattedTime = `${month}.${day} ${hours}:${minutes}:${seconds}`

	let result
	if (jackpotLevel) {
		result = `${jackpotLevel.rank} Prize ${currencySymbol} ${jackpotLevel.rewardMoney.toLocaleString()}`
	} else {
		result = `<span>${no_luck}</span>`
	}
	prizeVTScroll.innerHTML = `<span>${result}</span>`
	// ê¸°ë¡ì„ lotteryRecord ë°°ì—´ì— ì¶”ê°€
	lotteryRecord.push({ time: formattedTime, result: result })

	// ê¸°ë¡ì„ í™”ë©´ì— í‘œì‹œ
	displayLotteryRecord()
}

function displayLotteryRecord() {
	const recordDisplay = document.getElementById("recordDisplay")

	// ê¸°ë¡ í‘œì‹œ ì˜ì—­ì´ ì—†ë‹¤ë©´ ìƒì„±
	if (!recordDisplay) {
		const newRecordDisplay = document.createElement("div")
		newRecordDisplay.id = "recordDisplay"
		document.querySelector("main").appendChild(newRecordDisplay)
	}

	// ê¸°ë¡ì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
	const recordHtml = lotteryRecord.map((record) => `<div>${record.time} - ${record.result}</div>`).join("")

	recordDisplay.innerHTML = `${lottery_logs}${recordHtml}`
}
